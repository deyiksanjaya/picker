<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tampilan Papan Realtime</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .board-display {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            border: none;
            background-color: #000;
            padding: 2px;
        }
        .cell-display {
            width: 100px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5rem;
            font-weight: bold;
            color: #E5E7EB;
            border-right: 4px solid #4B5563;
            border-bottom: 4px solid #4B5563;
        }
        .cell-display:nth-child(3n) { border-right: none; }
        .cell-display:nth-child(n+7) { border-bottom: none; }

        @media (max-width: 400px) {
            .board-display {
                grid-template-columns: repeat(3, 80px);
                grid-template-rows: repeat(3, 80px);
            }
            .cell-display {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body class="bg-black text-gray-300 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="flex flex-col items-center">
        <h1 class="text-3xl font-bold mb-6 text-white">Status Papan Permainan</h1>
    
        <div id="board-display" class="board-display mb-8">
            <div class="cell-display" data-index="0"></div>
            <div class="cell-display" data-index="1"></div>
            <div class="cell-display" data-index="2"></div>
            <div class="cell-display" data-index="3"></div>
            <div class="cell-display" data-index="4"></div>
            <div class="cell-display" data-index="5"></div>
            <div class="cell-display" data-index="6"></div>
            <div class="cell-display" data-index="7"></div>
            <div class="cell-display" data-index="8"></div>
        </div>
    
        <button id="save-png-btn" class="px-6 py-2 bg-transparent border border-gray-600 text-gray-400 font-semibold rounded-lg hover:bg-gray-900 hover:text-white transition-colors">
            Simpan sebagai PNG
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBwCuf9-ASE4rAaF6KWjlwyZO9O8LMrXlc",
          authDomain: "tictactoeferdi.firebaseapp.com",
          databaseURL: "https://tictactoeferdi-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "tictactoeferdi",
          storageBucket: "tictactoeferdi.appspot.com",
          messagingSenderId: "868814364652",
          appId: "1:868814364652:web:1b749bad16d092b74eaac9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'magic-game-state');

        const cells = document.querySelectorAll('.cell-display');
        const boardDisplayDiv = document.getElementById('board-display');
        const savePngBtn = document.getElementById('save-png-btn');

        onValue(gameRef, (snapshot) => {
            // Langkah 1: Periksa apakah data ada di Firebase
            if (snapshot.exists()) {
                const gameState = snapshot.val();
                
                // Langkah 2: Lakukan validasi yang SANGAT KETAT pada data yang diterima
                // Data dianggap valid HANYA JIKA:
                // - gameState adalah sebuah objek (bukan null, string, atau angka)
                // - gameState memiliki properti 'board'
                // - Properti 'board' tersebut adalah sebuah array dengan panjang persis 9
                if (gameState && typeof gameState === 'object' && Array.isArray(gameState.board) && gameState.board.length === 9) {
                    // Jika semua validasi lolos, baru update tampilan
                    const board = gameState.board;
                    board.forEach((value, index) => {
                        if (cells[index]) {
                            cells[index].textContent = value || '';
                        }
                    });
                } else {
                    // Jika data ada tapi formatnya tidak sempurna, JANGAN LAKUKAN APA-APA.
                    // Cukup catat di console untuk debugging dan tunggu update data valid berikutnya.
                    // Ini mencegah error dan papan yang berkedip (flickering).
                    console.warn("Menerima data dengan format tidak sempurna, menunggu update berikutnya.", gameState);
                }

            } else {
                // Jika node 'magic-game-state' benar-benar tidak ada, baru kita kosongkan papan.
                cells.forEach(cell => cell.textContent = '');
                console.log("Node 'magic-game-state' tidak ditemukan. Papan dikosongkan.");
            }
        });

        savePngBtn.addEventListener('click', () => {
            html2canvas(boardDisplayDiv, {
                backgroundColor: '#000000',
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'papan-tictactoe.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        });

    </script>
</body>
</html>