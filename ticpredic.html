<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catatan Cepat</title>
    <meta name="theme-color" content="#FFFFFF"/>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Catatan">
    <link rel="apple-touch-icon" href="images/icons/icon-180x180.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; -webkit-user-select: none; -ms-user-select: none; user-select: none; overflow: hidden; background-color: #F3F4F6; }
        .main-container { width: 100vw; height: 100vh; padding: 20px; display: flex; align-items: center; justify-content: center; }
        #board-image {
            width: calc(100vmin - 40px);
            height: calc(100vmin - 40px);
            max-width: 100%; max-height: 100%;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.15s ease-out;
        }
        #board-image:active {
            transform: scale(0.97);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <button id="settings-btn" class="absolute top-5 right-5 z-20 p-2 rounded-full bg-white/80 backdrop-blur-sm shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </button>

    <div id="settings-panel" class="hidden absolute inset-0 z-10 bg-black/40 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-sm p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Pengaturan</h2>
            <div class="space-y-2">
                <label for="shortcut-name" class="text-gray-700 font-medium">Nama Pintasan:</label>
                <input type="text" id="shortcut-name" placeholder="Nama Pintasan Anda" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mt-4">
                <label class="text-gray-700 font-medium">Format Gambar:</label>
                <div class="mt-2 space-y-2">
                    <div class="flex items-center">
                        <input type="radio" id="format-square" name="image-format" value="square" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="format-square" class="ml-3 block text-sm text-gray-900">Square</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="format-portrait" name="image-format" value="portrait" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <label for="format-portrait" class="ml-3 block text-sm text-gray-900">Portrait</label>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end"><button id="save-settings-btn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Simpan</button></div>
        </div>
    </div>
    
    <div class="main-container">
        <img id="board-image" src="" alt="Papan Permainan">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyBwCuf9-ASE4rAaF6KWjlwyZO9O8LMrXlc",
          authDomain: "tictactoeferdi.firebaseapp.com",
          databaseURL: "https://tictactoeferdi-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "tictactoeferdi",
          storageBucket: "tictactoeferdi.appspot.com",
          messagingSenderId: "868814364652",
          appId: "1:868814364642:web:1b749bad16d092b74eaac9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'magic-game-state');

        const boardImage = document.getElementById('board-image');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const shortcutNameInput = document.getElementById('shortcut-name');

        let settings = { shortcutName: '', imageFormat: 'square' };
        let latestBoardData = Array(9).fill(null);
        const canvas = document.createElement('canvas');
        
        function renderDisplayBoard(boardData) {
            const ctx = canvas.getContext('2d');
            const size = 512;
            canvas.width = size;
            canvas.height = size;
            
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, size, size);
            const cellSize = size / 3;
            const lineThickness = 6;
            ctx.strokeStyle = '#CBD5E1';
            ctx.lineWidth = lineThickness;
            ctx.beginPath();
            for (let i = 1; i < 3; i++) {
                ctx.moveTo(i * cellSize, 0); ctx.lineTo(i * cellSize, size);
                ctx.moveTo(0, i * cellSize); ctx.lineTo(size, i * cellSize);
            }
            ctx.stroke();
            ctx.font = `bold ${cellSize * 0.7}px Poppins`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            boardData.forEach((value, index) => {
                if (!value) return;
                const row = Math.floor(index / 3); const col = index % 3;
                const x = col * cellSize + cellSize / 2;
                const y = row * cellSize + cellSize / 2;
                ctx.fillStyle = value === 'X' ? '#EF4444' : '#3B82F6';
                ctx.fillText(value, x, y);
            });
            
            boardImage.src = canvas.toDataURL('image/png');
        }
        
        // Fungsi ini hanya menggambar di kanvas, tidak mengembalikan apa-apa
        function generateOutputImageOnCanvas(boardData, format) {
            const ctx = canvas.getContext('2d');
            let boardSize, canvasWidth, canvasHeight;

            if (format === 'portrait') {
                canvasWidth = 420;
                canvasHeight = 910;
                boardSize = 420;
            } else { // 'square'
                canvasWidth = 512;
                canvasHeight = 512;
                boardSize = 512;
            }

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const startX = (canvas.width - boardSize) / 2;
            const startY = (canvas.height - boardSize) / 2;
            
            const cellSize = boardSize / 3;
            const lineThickness = 6;
            ctx.strokeStyle = '#CBD5E1';
            ctx.lineWidth = lineThickness;
            
            ctx.beginPath();
            for (let i = 1; i < 3; i++) {
                ctx.moveTo(startX + i * cellSize, startY);
                ctx.lineTo(startX + i * cellSize, startY + boardSize);
                ctx.moveTo(startX, startY + i * cellSize);
                ctx.lineTo(startX + boardSize, startY + i * cellSize);
            }
            ctx.stroke();

            ctx.font = `bold ${cellSize * 0.7}px Poppins`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            boardData.forEach((value, index) => {
                if (!value) return;
                const row = Math.floor(index / 3);
                const col = index % 3;
                const x = startX + col * cellSize + cellSize / 2;
                const y = startY + row * cellSize + cellSize / 2;
                ctx.fillStyle = value === 'X' ? '#EF4444' : '#3B82F6';
                ctx.fillText(value, x, y);
            });
        }


        async function handleBoardTap() {
            if (!settings.shortcutName) {
                settingsBtn.click();
                shortcutNameInput.focus();
                return;
            }
            
            try {
                // 1. Siapkan kanvas dengan gambar output yang benar
                generateOutputImageOnCanvas(latestBoardData, settings.imageFormat);
                
                // 2. Ubah kanvas menjadi Blob (data gambar mentah)
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                // 3. Salin Blob gambar ke papan klip
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);

                // 4. Redirect untuk menjalankan Pintasan
                const encodedShortcutName = encodeURIComponent(settings.shortcutName);
                const shortcutUrl = `shortcuts://run-shortcut?name=${encodedShortcutName}`;
                window.location.href = shortcutUrl;

            } catch (err) {
                console.error('Proses gagal:', err);
                // Di sini kita bisa menambahkan notifikasi jika diperlukan, tapi sekarang kita hilangkan
            }
        }
        
        function saveSettings() {
            settings.shortcutName = shortcutNameInput.value.trim();
            const selectedFormat = document.querySelector('input[name="image-format"]:checked').value;
            settings.imageFormat = selectedFormat;
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            settingsPanel.classList.add('hidden');
        }

        function loadSettings() {
            const savedSettings = JSON.parse(localStorage.getItem('appSettings'));
            if (savedSettings) {
                settings = { ...settings, ...savedSettings };
            }
            shortcutNameInput.value = settings.shortcutName;
            document.querySelector(`input[name="image-format"][value="${settings.imageFormat || 'square'}"]`).checked = true;
        }

        onValue(gameRef, (snapshot) => {
            const finalBoard = Array(9).fill(null);
            if (snapshot.exists()) {
                const gameState = snapshot.val();
                if (gameState && gameState.board) {
                    const receivedBoardData = gameState.board;
                    for (const index in receivedBoardData) {
                        const value = receivedBoardData[index];
                        const indexNum = parseInt(index, 10);
                        if (!isNaN(indexNum) && indexNum >= 0 && indexNum < 9) finalBoard[indexNum] = value;
                    }
                }
            }
            latestBoardData = [...finalBoard];
            renderDisplayBoard(finalBoard);
        });

        settingsBtn.addEventListener('click', () => settingsPanel.classList.remove('hidden'));
        saveSettingsBtn.addEventListener('click', saveSettings);
        settingsPanel.addEventListener('click', (e) => { if (e.target === settingsPanel) settingsPanel.classList.add('hidden'); });
        boardImage.addEventListener('click', handleBoardTap);
        
        loadSettings();
    </script>
    <script> if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/sw.js'); }); } </script>
</body>
</html>
