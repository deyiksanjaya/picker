<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Papan Skor</title>

    <!-- ### PWA META TAGS BARU ### -->

    <!-- Tema Warna Browser (Android) -->
    <meta name="theme-color" content="#000000"/>

    <!-- Link ke Manifest File -->
    <link rel="manifest" href="manifest.json">

    <!-- Meta Tags untuk Apple/iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Papan Skor">
    <link rel="apple-touch-icon" href="images/icons/icon-180x180.png">

    <!-- ### AKHIR DARI PWA META TAGS ### -->

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden;
        }
        #board-image {
            -webkit-user-drag: none;
        }
    </style>
</head>
<body class="bg-black text-gray-300 flex items-center justify-center min-h-screen">

    <img id="board-image" alt="Papan Permainan Tic-Tac-Toe" class="w-[306px] h-[306px] md:w-[306px] md:h-[306px]">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        // ... (Kode Firebase dan Canvas Anda yang sudah ada tidak berubah)
        const firebaseConfig = {
          apiKey: "AIzaSyBwCuf9-ASE4rAaF6KWjlwyZO9O8LMrXlc",
          authDomain: "tictactoeferdi.firebaseapp.com",
          databaseURL: "https://tictactoeferdi-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "tictactoeferdi",
          storageBucket: "tictactoeferdi.appspot.com",
          messagingSenderId: "868814364652",
          appId: "1:868814364652:web:1b749bad16d092b74eaac9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'magic-game-state');

        const boardImage = document.getElementById('board-image');
        const canvas = document.createElement('canvas');
        const CELL_SIZE = 100;
        const LINE_WIDTH = 4;
        const BOARD_SIZE = (CELL_SIZE * 3) + (LINE_WIDTH * 2);
        canvas.width = BOARD_SIZE;
        canvas.height = BOARD_SIZE;
        const ctx = canvas.getContext('2d');

        function updateBoardImage(boardData) {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#4B5563';
            ctx.lineWidth = LINE_WIDTH;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(CELL_SIZE + (LINE_WIDTH / 2), 0);
            ctx.lineTo(CELL_SIZE + (LINE_WIDTH / 2), BOARD_SIZE);
            ctx.moveTo(CELL_SIZE * 2 + (LINE_WIDTH * 1.5), 0);
            ctx.lineTo(CELL_SIZE * 2 + (LINE_WIDTH * 1.5), BOARD_SIZE);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, CELL_SIZE + (LINE_WIDTH / 2));
            ctx.lineTo(BOARD_SIZE, CELL_SIZE + (LINE_WIDTH / 2));
            ctx.moveTo(0, CELL_SIZE * 2 + (LINE_WIDTH * 1.5));
            ctx.lineTo(BOARD_SIZE, CELL_SIZE * 2 + (LINE_WIDTH * 1.5));
            ctx.stroke();
            ctx.fillStyle = '#E5E7EB';
            ctx.font = 'bold 3.5rem Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            boardData.forEach((value, index) => {
                if (value) {
                    const row = Math.floor(index / 3);
                    const col = index % 3;
                    const x = col * (CELL_SIZE + LINE_WIDTH) + (CELL_SIZE / 2);
                    const y = row * (CELL_SIZE + LINE_WIDTH) + (CELL_SIZE / 2);
                    ctx.fillText(value, x, y);
                }
            });
            boardImage.src = canvas.toDataURL('image/png');
        }
        
        onValue(gameRef, (snapshot) => {
            const finalBoard = Array(9).fill(null);
            if (snapshot.exists()) {
                const gameState = snapshot.val();
                if (gameState && gameState.board) {
                    const receivedBoardData = gameState.board;
                    for (const index in receivedBoardData) {
                        const value = receivedBoardData[index];
                        const indexNum = parseInt(index, 10);
                        if (!isNaN(indexNum) && indexNum >= 0 && indexNum < 9) {
                            finalBoard[indexNum] = value;
                        }
                    }
                }
            }
            updateBoardImage(finalBoard);
        });

    </script>
    
    <!-- ### KODE BARU: Mendaftarkan Service Worker ### -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>